<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-key="page_title">แบบฟอร์มลงทะเบียนผู้ป่วยใหม่ - บ้านหมอละออง</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        
        :root {
            --brand-green-dark: #079247; --brand-green-light: #8dc63f;
            --brand-yellow: #fbca16; --brand-brown: #664019;
            --bg-color: #f4f7f6; --container-bg: #FFFFFF;
            --header-bg: linear-gradient(135deg, var(--brand-green-light) 0%, var(--brand-green-dark) 100%);
            --button-gradient: linear-gradient(135deg, var(--brand-green-dark) 0%, var(--brand-green-light) 100%);
            --text-primary: #333; --text-secondary: #555;
            --border-color: #DEE2E6; --input-bg: #F8F9FA;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --transition-smooth: cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Sarabun', Arial, sans-serif; background-color: var(--bg-color);
            min-height: 100vh; padding: 20px;
            display: flex; align-items: center; justify-content: center;
        }
        
        .hidden { display: none !important; }

        .container {
            max-width: 1000px; width: 100%; margin: 20px auto;
            background: var(--container-bg); border-radius: 30px;
            box-shadow: var(--shadow); overflow: hidden;
            border: 1px solid var(--border-color); animation: fadeInUp 1s ease-out;
        }
        
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        .header {
            background: var(--header-bg); color: white; padding: 40px 30px;
            text-align: center; position: relative;
        }
        
        .header h1 { font-size: 2.5em; margin-bottom: 10px; font-weight: 700; text-shadow: 1px 1px 3px rgba(0,0,0,0.2); }
        .header p { font-size: 1.2em; opacity: 0.95; }
        
        .language-switcher { 
            position: absolute; top: 20px; right: 30px; z-index: 10;
            background: rgba(0, 0, 0, 0.2); border-radius: 20px; 
            padding: 5px; display: flex; gap: 5px; 
        }
        .language-switcher button {
            background: transparent; border: none; color: white; padding: 8px 15px;
            cursor: pointer; font-size: 0.9em; font-weight: 600;
            border-radius: 15px; transition: background 0.3s;
            font-family: 'Sarabun', sans-serif;
        }
        .language-switcher button.active { background: rgba(255, 255, 255, 0.3); }

        .form-container { padding: 40px 50px; }
        .section {
             margin-bottom: 40px; padding: 30px; border-radius: 25px;
             background: #fff; border: 1px solid #f0f0f0;
             animation: fadeInStep 0.6s ease-out forwards;
        }
        @keyframes fadeInStep { from { opacity: 0; } to { opacity: 1; } }

        .section-title {
            font-size: 1.8em; font-weight: 700; color: var(--brand-brown);
            margin-bottom: 30px; display: flex; align-items: center; gap: 15px;
            padding-bottom: 10px; border-bottom: 2px solid var(--brand-green-light);
        }
        .section-icon {
            font-size: 1.2em; color: white; background: var(--brand-green-dark);
            width: 50px; height: 50px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; flex-shrink: 0;
        }

        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 30px; margin-bottom: 25px; }
        .form-group { display: flex; flex-direction: column; position: relative; }
        .form-group.full-width { grid-column: 1 / -1; }
        label { font-weight: 600; color: var(--text-primary); margin-bottom: 10px; font-size: 1.05em; }
        .required { color: #e74c3c; margin-left: 2px;}
        input, select, textarea {
            padding: 15px 20px; border: 1px solid var(--border-color);
            border-radius: 15px; font-size: 1.05em; font-family: 'Sarabun', sans-serif;
            transition: all 0.3s var(--transition-smooth); background-color: var(--input-bg);
            width: 100%;
        }
        input:focus, select:focus, textarea:focus {
            outline: none; border-color: var(--brand-green-dark);
            box-shadow: 0 0 0 4px rgba(7, 146, 71, 0.15);
        }
        input:read-only { background-color: #e9ecef; cursor: not-allowed; }
        input.is-invalid, select.is-invalid, textarea.is-invalid { border-color: #dc3545 !important; }
        textarea { resize: vertical; min-height: 120px; }
        
        /* --- Checkbox Style Update --- */
        .checkbox-group { display: flex; flex-direction: column; gap: 15px; }
        .checkbox-item {
            display: flex; align-items: flex-start; cursor: pointer;
            font-size: 1em; padding: 12px; border-radius: 12px;
            border: 1px solid var(--border-color); transition: all 0.2s;
        }
        .checkbox-item:hover { background-color: #f7fbf3; }
        .checkbox-item input[type="checkbox"] {
            -webkit-appearance: none; appearance: none; background-color: #fff;
            margin: 0; font: inherit; color: currentColor;
            width: 1.15em; height: 1.15em; border: 0.15em solid var(--border-color);
            border-radius: 0.15em; transform: translateY(0.2em);
            margin-right: 0.8em; /* Increased space */
            display: grid; place-content: center; flex-shrink: 0;
        }
        .checkbox-item span { flex: 1; } /* Allow text to take up space */
        .checkbox-item input[type="checkbox"]::before {
            content: ""; width: 0.65em; height: 0.65em;
            transform: scale(0); transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em var(--brand-green-dark);
            transform-origin: bottom left;
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }
        .checkbox-item input[type="checkbox"]:checked::before { transform: scale(1); }
        .checkbox-item.is-invalid { border-color: #dc3545; }

        .validation-message { margin-top: 8px; font-size: 0.9em; font-weight: 500; color: #dc3545; display: none; }
        .validation-message.show { display: block; }
        
        .progress-container { margin-bottom: 40px; }
        .progress-bar { width: 100%; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--button-gradient); width: 0%; border-radius: 4px; transition: width 0.6s var(--transition-smooth); }
        .progress-text { text-align: center; margin-top: 10px; font-weight: 600; color: var(--text-secondary); }
        .step-indicator { display: flex; justify-content: center; align-items: center; margin-bottom: 30px; gap: 20px; }
        .step { width: 40px; height: 40px; border-radius: 50%; background: #e9ecef; display: flex; align-items: center; justify-content: center; font-weight: 700; color: #888; transition: all 0.4s var(--transition-smooth); position: relative; flex-shrink: 0; }
        .step.active { background: var(--button-gradient); color: white; transform: scale(1.15); box-shadow: 0 0 15px rgba(141, 198, 63, 0.5); }
        .step.completed { background: var(--brand-green-dark); color: white; }
        .step.completed span { display: none; }
        .step.completed::after { content: '✓'; font-weight: 900; }
        .step-line { width: 60px; height: 4px; background: #e9ecef; transition: all 0.4s ease; border-radius: 2px; }
        .step-line.active { background: var(--button-gradient); }
        .navigation-buttons { display: flex; justify-content: space-between; margin-top: 40px; border-top: 1px solid var(--border-color); padding-top: 30px;}
        .nav-btn { padding: 15px 35px; border: none; border-radius: 25px; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: all 0.3s; font-family: 'Sarabun', sans-serif; text-transform: uppercase; letter-spacing: 1px; color: white; }
        .btn-prev { background: #6c757d; }
        .btn-next, .btn-submit { background: var(--button-gradient); }
        .nav-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 9999; }
        .loading-overlay.show { display: flex; }
        .loading-spinner { width: 60px; height: 60px; border: 6px solid var(--brand-green-light); border-radius: 50%; border-top-color: var(--brand-green-dark); animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #success-message { text-align: center; padding: 40px; }
        .success-icon { font-size: 5em; color: var(--brand-green-dark); margin-bottom: 20px; animation: popIn 0.5s ease-out; }
        #success-message h2 { font-size: 2em; color: var(--brand-green-dark); margin-bottom: 10px;}
        #success-message p { font-size: 1.2em; color: var(--text-primary); }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0;} to { transform: scale(1); opacity: 1;} }

        @media (max-width: 768px) {
            body { padding: 0; align-items: flex-start; }
            .container { border-radius: 0; margin: 0; }
            .form-container { padding: 20px; }
            .header h1 { font-size: 2.2em; }
        }
    </style>
</head>
<body>

<!-- Patient Registration Form View -->
<div class="container" id="form-view">
    <div class="header">
        <div class="language-switcher">
            <button id="lang-th" class="active">ไทย</button>
            <button id="lang-en">EN</button>
        </div>
        <h1 data-key="form_title">แบบฟอร์มลงทะเบียนผู้ป่วยใหม่</h1>
        <p data-key="form_subtitle">บ้านหมอละออง เวลเนส เซ็นเตอร์</p>
    </div>
    
    <div class="form-container">
        <div id="form-content">
            <!-- Progress Bar & Steps -->
            <div class="step-indicator" id="stepIndicator">
                <div class="step" data-step="1"><span>1</span></div><div class="step-line"></div>
                <div class="step" data-step="2"><span>2</span></div><div class="step-line"></div>
                <div class="step" data-step="3"><span>3</span></div><div class="step-line"></div>
                <div class="step" data-step="4"><span>4</span></div>
            </div>
            <div class="progress-container">
                <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
                <div class="progress-text" id="progressText"></div>
            </div>
            
            <!-- Form Sections -->
            <form id="registrationForm" novalidate>
                 <!-- Step 1: Personal Info -->
                <div class="section" id="step1">
                    <h2 class="section-title"><div class="section-icon"><i class="fas fa-user"></i></div><span data-key="step1_title">ข้อมูลส่วนบุคคลและการติดต่อ</span></h2>
                    <div class="form-row">
                        <div class="form-group"><label for="title" data-key="label_title">คำนำหน้าชื่อ <span class="required">*</span></label><select id="title" name="title" required><option value="" data-key="option_select_title">เลือกคำนำหน้า</option><option value="นาย" data-key="option_mr">นาย</option><option value="นาง" data-key="option_mrs">นาง</option><option value="นางสาว" data-key="option_ms">นางสาว</option></select><div class="validation-message" id="title-error"></div></div>
                        <div class="form-group"><label for="firstName" data-key="label_firstName">ชื่อ <span class="required">*</span></label><input type="text" id="firstName" name="firstName" required data-key-placeholder="placeholder_firstName" placeholder="ชื่อจริง"><div class="validation-message" id="firstName-error"></div></div>
                        <div class="form-group"><label for="lastName" data-key="label_lastName">นามสกุล <span class="required">*</span></label><input type="text" id="lastName" name="lastName" required data-key-placeholder="placeholder_lastName" placeholder="นามสกุล"><div class="validation-message" id="lastName-error"></div></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label for="idCard" data-key="label_idCard">เลขบัตรประชาชน <span class="required">*</span></label><input type="text" id="idCard" name="idCard" pattern="\d{13}" maxlength="13" required placeholder="1234567890123"><div class="validation-message" id="idCard-error"></div></div>
                        <div class="form-group"><label for="birthDate" data-key="label_birthDate">วันเกิด <span class="required">*</span></label><input type="date" id="birthDate" name="birthDate" required><div class="validation-message" id="birthDate-error"></div></div>
                        <div class="form-group"><label for="age" data-key="label_age">อายุ (ปี) <span class="required">*</span></label><input type="number" id="age" name="age" required data-key-placeholder="placeholder_age" placeholder="คำนวณอัตโนมัติ" min="1" max="100" readonly><div class="validation-message" id="age-error"></div></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label for="phone" data-key="label_phone">เบอร์โทรศัพท์ <span class="required">*</span></label><input type="tel" id="phone" name="phone" required placeholder="0812345678" pattern="\d{10}" maxlength="10"><div class="validation-message" id="phone-error"></div></div>
                        <div class="form-group full-width"><label for="address" data-key="label_address">ที่อยู่ปัจจุบัน <span class="required">*</span></label><textarea id="address" name="address" required data-key-placeholder="placeholder_address" placeholder="บ้านเลขที่, ถนน, ตำบล/แขวง, อำเภอ/เขต, จังหวัด, รหัสไปรษณีย์"></textarea><div class="validation-message" id="address-error"></div></div>
                    </div>
                </div>
                <!-- Other steps are identical -->
                <div class="section hidden" id="step2">
                    <h2 class="section-title"><div class="section-icon"><i class="fas fa-users"></i></div><span data-key="step2_title">ข้อมูลเพิ่มเติมและผู้ติดต่อฉุกเฉิน</span></h2>
                    <div class="form-group"><label for="occupation" data-key="label_occupation">อาชีพ</label><input type="text" id="occupation" name="occupation" data-key-placeholder="placeholder_occupation" placeholder="เช่น พนักงานบริษัท, ธุรกิจส่วนตัว"></div>
                    <div class="form-group"><label for="emergencyContactName" data-key="label_emergencyName">ชื่อผู้ติดต่อฉุกเฉิน <span class="required">*</span></label><input type="text" id="emergencyContactName" name="emergencyContactName" required data-key-placeholder="placeholder_emergencyName" placeholder="ชื่อ-นามสกุล"><div class="validation-message" id="emergencyContactName-error"></div></div>
                    <div class="form-row">
                        <div class="form-group"><label for="emergencyRelation" data-key="label_emergencyRelation">ความสัมพันธ์ <span class="required">*</span></label><input type="text" id="emergencyRelation" name="emergencyRelation" required data-key-placeholder="placeholder_emergencyRelation" placeholder="เช่น บิดา, มารดา, คู่สมรส"><div class="validation-message" id="emergencyRelation-error"></div></div>
                        <div class="form-group"><label for="emergencyPhone" data-key="label_emergencyPhone">เบอร์โทรศัพท์ผู้ติดต่อ <span class="required">*</span></label><input type="tel" id="emergencyPhone" name="emergencyPhone" required placeholder="0812345678" pattern="\d{10}" maxlength="10"><div class="validation-message" id="emergencyPhone-error"></div></div>
                    </div>
                </div>
                <div class="section hidden" id="step3">
                     <h2 class="section-title"><div class="section-icon"><i class="fas fa-heartbeat"></i></div><span data-key="step3_title">ข้อมูลสำคัญทางการแพทย์</span></h2>
                     <div class="form-group full-width"><label for="underlyingDisease" data-key="label_disease">โรคประจำตัว <span class="required">*</span></label><textarea id="underlyingDisease" name="underlyingDisease" required data-key-placeholder="placeholder_disease" placeholder="ระบุโรคประจำตัวของท่าน หากไม่มีกรุณาใส่ 'ไม่มี'"></textarea><div class="validation-message" id="underlyingDisease-error"></div></div>
                     <div class="form-group full-width"><label for="drugAllergy" data-key="label_drugAllergy">ประวัติการแพ้ยา <span class="required">*</span></label><textarea id="drugAllergy" name="drugAllergy" required data-key-placeholder="placeholder_drugAllergy" placeholder="ระบุยาที่ท่านแพ้ หากไม่มีกรุณาใส่ 'ไม่มี'"></textarea><div class="validation-message" id="drugAllergy-error"></div></div>
                     <div class="form-group full-width"><label for="reasonForVisit" data-key="label_reasonForVisit">เหตุผลหลักที่มารับบริการ <span class="required">*</span></label><textarea id="reasonForVisit" name="reasonForVisit" required data-key-placeholder="placeholder_reasonForVisit" placeholder="อธิบายอาการเบื้องต้นที่ทำให้ท่านมาที่คลินิกในวันนี้"></textarea><div class="validation-message" id="reasonForVisit-error"></div></div>
                </div>
                <div class="section hidden" id="step4">
                     <h2 class="section-title"><div class="section-icon"><i class="fas fa-file-signature"></i></div><span data-key="step4_title">การชำระเงิน และ การยืนยันข้อมูล</span></h2>
                     <div class="form-group full-width"><label for="paymentMethod" data-key="label_paymentMethod">วิธีการชำระเงิน <span class="required">*</span></label><select id="paymentMethod" name="paymentMethod" required><option value="" data-key="option_select_payment">-- กรุณาเลือก --</option><option value="self_pay" data-key="option_self_pay">ชำระเงินเอง</option><option value="private_insurance" data-key="option_private_insurance">ใช้สิทธิประกันสุขภาพเอกชน</option><option value="corporate_partner" data-key="option_corporate_partner">ใช้สิทธิบริษัทคู่สัญญา</option></select><div class="validation-message" id="paymentMethod-error"></div></div>
                     <div id="insuranceDetails" class="hidden" style="animation: fadeInUp 0.5s;"><div class="form-row"><div class="form-group"><label for="insuranceCompany" data-key="label_insuranceCompany">ชื่อบริษัทประกัน / บริษัทคู่สัญญา</label><input type="text" id="insuranceCompany" name="insuranceCompany" data-key-placeholder="placeholder_insuranceCompany" placeholder="ระบุชื่อบริษัท"></div><div class="form-group"><label for="policyNumber" data-key="label_policyNumber">เลขกรมธรรม์ / รหัสพนักงาน</label><input type="text" id="policyNumber" name="policyNumber" data-key-placeholder="placeholder_policyNumber" placeholder="ระบุหมายเลข"></div></div></div>
                     <div class="form-group full-width" style="margin-top: 30px;">
                        <label data-key="label_ack"><i class="label-icon fas fa-check-double"></i>การยืนยันข้อมูล <span class="required">*</span></label>
                        <div class="checkbox-group">
                            <label class="checkbox-item" id="ack_truth_label">
                                <input type="checkbox" name="ack_truth" id="ack_truth" required>
                                <span data-key="ack_truth_text">ข้าพเจ้าขอยืนยันว่าข้อมูลที่ให้ไว้ในแบบฟอร์มนี้เป็นความจริงทุกประการ</span>
                            </label>
                            <label class="checkbox-item" id="ack_pdpa_label">
                                <input type="checkbox" name="ack_pdpa" id="ack_pdpa" required>
                                <span data-key="ack_pdpa_text">ข้าพเจ้าได้รับทราบและให้ความยินยอมตาม "แบบฟอร์มความยินยอมด้านข้อมูลส่วนบุคคล (CLN-F70)" เรียบร้อยแล้ว</span>
                            </label>
                        </div>
                        <div class="validation-message" id="ack_truth-error"></div>
                    </div>
                </div>
                <!-- Navigation Buttons -->
                <div class="navigation-buttons">
                    <button type="button" class="nav-btn btn-prev" id="prevBtn" data-key="btn_prev">ย้อนกลับ</button>
                    <button type="button" class="nav-btn btn-next" id="nextBtn" data-key="btn_next">ถัดไป</button>
                    <button type="submit" class="nav-btn btn-submit hidden" id="submitBtn" data-key="btn_submit">ส่งข้อมูล</button>
                </div>
            </form>
        </div>
        <!-- Success Message -->
        <div id="success-message" class="hidden">
            <div class="success-icon"><i class="fas fa-check-circle"></i></div>
            <h2 data-key="success_title">ลงทะเบียนสำเร็จ!</h2>
            <p data-key="success_subtitle">ขอบคุณที่ให้ข้อมูลกับเรา เจ้าหน้าที่จะติดต่อกลับเร็วที่สุด</p>
        </div>
    </div>
</div>

<div class="loading-overlay" id="loadingOverlay"><div class="loading-spinner"></div></div>

<!-- SCRIPT SECTION -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    
    // IMPORTANT: Paste your Google Apps Script Web App URL here
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyUTdOhUzM4zhfbEs7FeU9m-Y7G3zPsoHVmzs9Z6tZo_tFTFS6zbb015uri0O36DOvPKg/exec"; 

    const translations = {
        th: {
            page_title: 'แบบฟอร์มลงทะเบียนผู้ป่วยใหม่ - บ้านหมอละออง', form_title: 'แบบฟอร์มลงทะเบียนผู้ป่วยใหม่', form_subtitle: 'บ้านหมอละออง เวลเนส เซ็นเตอร์',
            progress_text: 'ขั้นตอนที่ {step} จาก {total}',
            step1_title: 'ข้อมูลส่วนบุคคลและการติดต่อ', label_title: 'คำนำหน้าชื่อ', option_select_title: 'เลือกคำนำหน้า', option_mr: 'นาย', option_mrs: 'นาง', option_ms: 'นางสาว',
            label_firstName: 'ชื่อ', placeholder_firstName: 'ชื่อจริง', label_lastName: 'นามสกุล', placeholder_lastName: 'นามสกุล',
            label_idCard: 'เลขบัตรประชาชน', label_birthDate: 'วันเกิด', label_age: 'อายุ (ปี)', placeholder_age: 'คำนวณอัตโนมัติ',
            label_phone: 'เบอร์โทรศัพท์', label_address: 'ที่อยู่ปัจจุบัน', placeholder_address: 'บ้านเลขที่, ถนน, ตำบล/แขวง, อำเภอ/เขต, จังหวัด, รหัสไปรษณีย์',
            step2_title: 'ข้อมูลเพิ่มเติมและผู้ติดต่อฉุกเฉิน', label_occupation: 'อาชีพ', placeholder_occupation: 'เช่น พนักงานบริษัท, ธุรกิจส่วนตัว',
            label_emergencyName: 'ชื่อผู้ติดต่อฉุกเฉิน', placeholder_emergencyName: 'ชื่อ-นามสกุล', label_emergencyRelation: 'ความสัมพันธ์', placeholder_emergencyRelation: 'เช่น บิดา, มารดา, คู่สมรส',
            label_emergencyPhone: 'เบอร์โทรศัพท์ผู้ติดต่อ',
            step3_title: 'ข้อมูลสำคัญทางการแพทย์', label_disease: 'โรคประจำตัว', placeholder_disease: "ระบุโรคประจำตัวของท่าน หากไม่มีกรุณาใส่ 'ไม่มี'",
            label_drugAllergy: 'ประวัติการแพ้ยา', placeholder_drugAllergy: "ระบุยาที่ท่านแพ้ หากไม่มีกรุณาใส่ 'ไม่มี'",
            label_reasonForVisit: 'เหตุผลหลักที่มารับบริการ', placeholder_reasonForVisit: 'อธิบายอาการเบื้องต้นที่ทำให้ท่านมาที่คลินิกในวันนี้',
            step4_title: 'การชำระเงิน และ การยืนยันข้อมูล', label_paymentMethod: 'วิธีการชำระเงิน', option_select_payment: '-- กรุณาเลือก --', option_self_pay: 'ชำระเงินเอง', option_private_insurance: 'ใช้สิทธิประกันสุขภาพเอกชน', option_corporate_partner: 'ใช้สิทธิบริษัทคู่สัญญา',
            label_insuranceCompany: 'ชื่อบริษัทประกัน / บริษัทคู่สัญญา', placeholder_insuranceCompany: 'ระบุชื่อบริษัท', label_policyNumber: 'เลขกรมธรรม์ / รหัสพนักงาน', placeholder_policyNumber: 'ระบุหมายเลข',
            label_ack: 'การยืนยันข้อมูล', ack_truth_text: 'ข้าพเจ้าขอยืนยันว่าข้อมูลที่ให้ไว้ในแบบฟอร์มนี้เป็นความจริงทุกประการ',
            ack_pdpa_text: 'ข้าพเจ้าได้รับทราบและให้ความยินยอมตาม "แบบฟอร์มความยินยอมด้านข้อมูลส่วนบุคคล (CLN-F70)" เรียบร้อยแล้ว',
            btn_prev: 'ย้อนกลับ', btn_next: 'ถัดไป', btn_submit: 'ส่งข้อมูล',
            success_title: 'ลงทะเบียนสำเร็จ!', success_subtitle: 'ขอบคุณที่ให้ข้อมูลกับเรา เจ้าหน้าที่จะติดต่อกลับเร็วที่สุด',
            validation_required: 'กรุณากรอกข้อมูลนี้', validation_pattern_id: 'เลขบัตรประชาชนต้องมี 13 หลัก',
            validation_pattern_phone: 'เบอร์โทรศัพท์ต้องมี 10 หลัก', validation_checkbox: 'กรุณายืนยันทั้งสองช่อง',
            validation_age_range: 'อายุต้องอยู่ระหว่าง 1 ถึง 100 ปี'
        },
        en: {
            page_title: 'New Patient Registration Form - Baan Moh La-ong', form_title: 'New Patient Registration Form', form_subtitle: 'Baan Moh La-ong Wellness Center',
            progress_text: 'Step {step} of {total}',
            step1_title: 'Personal and Contact Information', label_title: 'Title', option_select_title: 'Select Title', option_mr: 'Mr.', option_mrs: 'Mrs.', option_ms: 'Ms.',
            label_firstName: 'First Name', placeholder_firstName: 'Your first name', label_lastName: 'Last Name', placeholder_lastName: 'Your last name',
            label_idCard: 'National ID Number', label_birthDate: 'Date of Birth', label_age: 'Age (Years)', placeholder_age: 'Auto-calculated',
            label_phone: 'Phone Number', label_address: 'Current Address', placeholder_address: 'House No., Street, Sub-district, District, Province, Postal Code',
            step2_title: 'Additional Info & Emergency Contact', label_occupation: 'Occupation', placeholder_occupation: 'e.g., Office Worker, Business Owner',
            label_emergencyName: 'Emergency Contact Name', placeholder_emergencyName: 'Full Name', label_emergencyRelation: 'Relationship', placeholder_emergencyRelation: 'e.g., Father, Mother, Spouse',
            label_emergencyPhone: 'Emergency Contact Phone',
            step3_title: 'Medical Information', label_disease: 'Chronic Disease', placeholder_disease: "List your chronic diseases. If none, please type 'None'.",
            label_drugAllergy: 'Drug Allergy History', placeholder_drugAllergy: "List drugs you are allergic to. If none, please type 'None'.",
            label_reasonForVisit: 'Main Reason for Visit', placeholder_reasonForVisit: 'Briefly describe the symptoms that brought you to the clinic today.',
            step4_title: 'Payment & Acknowledgment', label_paymentMethod: 'Payment Method', option_select_payment: '-- Please Select --', option_self_pay: 'Self-Pay', option_private_insurance: 'Private Health Insurance', option_corporate_partner: 'Corporate Partner',
            label_insuranceCompany: 'Insurance / Corporate Partner Company', placeholder_insuranceCompany: 'Enter company name',
            label_policyNumber: 'Policy / Employee ID Number', placeholder_policyNumber: 'Enter number',
            label_ack: 'Acknowledgment', ack_truth_text: 'I hereby confirm that the information provided in this form is true and correct.',
            ack_pdpa_text: 'I have read and agree to the "Personal Data Consent Form (CLN-F70)".',
            btn_prev: 'Back', btn_next: 'Next', btn_submit: 'Submit',
            success_title: 'Registration Successful!', success_subtitle: 'Thank you for your information. Our staff will contact you shortly.',
            validation_required: 'This field is required', validation_pattern_id: 'ID number must be 13 digits',
            validation_pattern_phone: 'Phone number must be 10 digits', validation_checkbox: 'Please check both boxes',
            validation_age_range: 'Age must be between 1 and 100 years'
        }
    };

    // DOM Elements
    const form = document.getElementById('registrationForm');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const stepIndicator = document.getElementById('stepIndicator');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const paymentMethodSelect = document.getElementById('paymentMethod');
    const insuranceDetails = document.getElementById('insuranceDetails');
    const birthDateInput = document.getElementById('birthDate');
    const ageInput = document.getElementById('age');

    const sections = Array.from(form.querySelectorAll('.section'));
    const totalSteps = sections.length;
    let currentStep = 1;
    let currentLang = 'th';

    // --- Functions ---
    const setDateConstraints = () => {
        const today = new Date();
        const maxDate = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate() + 1);
        const minDate = new Date(today.getFullYear() - 100, today.getMonth(), today.getDate());
        birthDateInput.max = maxDate.toISOString().split('T')[0];
        birthDateInput.min = minDate.toISOString().split('T')[0];
    };

    const updateUI = () => {
        sections.forEach((section, index) => section.classList.toggle('hidden', (index + 1) !== currentStep));
        const progressPercentage = totalSteps > 1 ? ((currentStep - 1) / (totalSteps - 1)) * 100 : 0;
        progressFill.style.width = `${progressPercentage}%`;
        
        const steps = stepIndicator.querySelectorAll('.step');
        const lines = stepIndicator.querySelectorAll('.step-line');
        steps.forEach((step, index) => {
            step.classList.toggle('active', (index + 1) === currentStep);
            step.classList.toggle('completed', (index + 1) < currentStep);
        });
        lines.forEach((line, index) => line.classList.toggle('active', (index + 1) < currentStep));

        prevBtn.classList.toggle('hidden', currentStep === 1);
        prevBtn.disabled = currentStep === 1;
        nextBtn.classList.toggle('hidden', currentStep === totalSteps);
        submitBtn.classList.toggle('hidden', currentStep !== totalSteps);
        switchLanguage(currentLang); // Refresh text
    };

    const validateStep = (stepIndex) => {
        let isValid = true;
        const currentSection = sections[stepIndex - 1];
        const inputs = currentSection.querySelectorAll('[required]');
        currentSection.querySelectorAll('.validation-message').forEach(el => el.classList.remove('show'));
        currentSection.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
        
        inputs.forEach(input => {
            let fieldValid = true;
            let errorKey = 'validation_required';
            if (input.type === 'checkbox') {
                if (!input.checked) {
                    fieldValid = false;
                    document.getElementById('ack_truth-error').textContent = translations[currentLang].validation_checkbox;
                    document.getElementById('ack_truth-error').classList.add('show');
                    document.getElementById('ack_truth_label').classList.add('is-invalid');
                    document.getElementById('ack_pdpa_label').classList.add('is-invalid');
                }
            } else if (input.type === 'date') {
                if (!input.value) fieldValid = false;
                else {
                    const age = calculateAge(false);
                    if (age < 1 || age > 100) {
                        fieldValid = false;
                        errorKey = 'validation_age_range';
                    }
                }
            } else {
                if (!input.value.trim()) fieldValid = false;
                else if (input.pattern) {
                    if (!new RegExp(input.pattern).test(input.value)) {
                        fieldValid = false;
                        errorKey = (input.id.includes('idCard')) ? 'validation_pattern_id' : 'validation_pattern_phone';
                    }
                }
            }
            if (!fieldValid) {
                isValid = false;
                if (input.type === 'checkbox') {
                    input.closest('.checkbox-item').classList.add('is-invalid');
                } else {
                    input.classList.add('is-invalid');
                }
                const errorDiv = document.getElementById(`${input.id}-error`);
                if (errorDiv) {
                    errorDiv.textContent = translations[currentLang][errorKey];
                    errorDiv.classList.add('show');
                }
            }
        });
        if (stepIndex === 4 && document.getElementById('ack_truth').checked && document.getElementById('ack_pdpa').checked) {
            document.getElementById('ack_truth-error').classList.remove('show');
            document.getElementById('ack_truth_label').classList.remove('is-invalid');
            document.getElementById('ack_pdpa_label').classList.remove('is-invalid');
        }
        return isValid;
    };

    const switchLanguage = (lang) => {
        currentLang = lang;
        document.documentElement.lang = lang;
        document.getElementById('lang-th').classList.toggle('active', lang === 'th');
        document.getElementById('lang-en').classList.toggle('active', lang === 'en');
        document.querySelectorAll('[data-key]').forEach(el => {
            const key = el.getAttribute('data-key');
            if (translations[lang][key]) {
                const content = translations[lang][key].replace('{step}', currentStep).replace('{total}', totalSteps);
                const icon = el.querySelector('i');
                const requiredSpan = el.querySelector('.required');
                const textSpan = el.querySelector('span:not([class])');
                
                if(textSpan) {
                     textSpan.textContent = content;
                } else if (el.childNodes.length > 0) {
                    const textNode = Array.from(el.childNodes).find(node => node.nodeType === Node.TEXT_NODE && node.textContent.trim());
                    if(textNode) textNode.textContent = content;
                    else el.textContent = content;
                } else {
                    el.textContent = content;
                }

                if(icon) el.prepend(icon);
                if(requiredSpan) el.append(requiredSpan);
            }
        });
        document.querySelectorAll('[data-key-placeholder]').forEach(el => {
            const key = el.getAttribute('data-key-placeholder');
            if (translations[lang][key]) el.placeholder = translations[lang][key];
        });
        validateStep(currentStep);
    };

    const calculateAge = (updateField = true) => {
        if (!birthDateInput.value) { if(updateField) ageInput.value = ''; return null; }
        const birthDate = new Date(birthDateInput.value);
        const today = new Date();
        let age = today.getFullYear() - birthDate.getFullYear();
        const m = today.getMonth() - birthDate.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
        if (updateField) ageInput.value = age >= 0 ? age : '';
        return age;
    };

    const handlePaymentMethodChange = () => {
        const selectedValue = paymentMethodSelect.value;
        const requiredFields = insuranceDetails.querySelectorAll('input');
        if (selectedValue === 'private_insurance' || selectedValue === 'corporate_partner') {
            insuranceDetails.classList.remove('hidden');
            requiredFields.forEach(input => input.setAttribute('required', ''));
        } else {
            insuranceDetails.classList.add('hidden');
            requiredFields.forEach(input => {
                input.removeAttribute('required');
                input.classList.remove('is-invalid');
                const errorDiv = document.getElementById(`${input.id}-error`);
                if(errorDiv) errorDiv.classList.remove('show');
            });
        }
    };

    const submitForm = (e) => {
        e.preventDefault();
        if (SCRIPT_URL === "YOUR_WEB_APP_URL_HERE" || !SCRIPT_URL) {
            alert("Please paste your Web App URL into the SCRIPT_URL variable in the code.");
            return;
        }
        loadingOverlay.classList.add('show');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        
        fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors', 
            cache: 'no-cache',
            headers: {
                'Content-Type': 'application/json'
            },
            redirect: 'follow',
            body: JSON.stringify(data)
        })
        .then(res => {
            loadingOverlay.classList.remove('show');
            document.getElementById('form-content').classList.add('hidden');
            document.getElementById('success-message').classList.remove('hidden');
        })
        .catch(err => {
            console.error("Error submitting to Google Sheet: ", err);
            loadingOverlay.classList.remove('show');
            alert("เกิดข้อผิดพลาดในการบันทึกข้อมูล กรุณาลองใหม่อีกครั้ง");
        });
    };

    // Event Listeners
    nextBtn.addEventListener('click', () => { if (validateStep(currentStep)) { if (currentStep < totalSteps) { currentStep++; window.scrollTo(0, 0); updateUI(); } } });
    prevBtn.addEventListener('click', () => { if (currentStep > 1) { currentStep--; window.scrollTo(0, 0); updateUI(); } });
    form.addEventListener('submit', submitForm);
    form.addEventListener('input', (e) => { 
        if (e.target.hasAttribute('required')) {
            const parentLabel = e.target.closest('.checkbox-item');
            if(parentLabel) {
                parentLabel.classList.remove('is-invalid');
            } else {
                e.target.classList.remove('is-invalid');
            }
            const errorDiv = document.getElementById(`${e.target.id}-error`);
            if (errorDiv) errorDiv.classList.remove('show');
        }
     });
    document.getElementById('lang-th').addEventListener('click', () => switchLanguage('th'));
    document.getElementById('lang-en').addEventListener('click', () => switchLanguage('en'));
    birthDateInput.addEventListener('change', () => { calculateAge(); validateStep(1); });
    paymentMethodSelect.addEventListener('change', handlePaymentMethodChange);

    // Initial Setup
    setDateConstraints();
    updateUI();
});
</script>

</body>
</html>
